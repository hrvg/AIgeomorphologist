---
title: "retrieving sentinel 2 products"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{retrieving sentinel 2 products}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
```

```{r, include = FALSE}
devtools::load_all()
```

# Getting data

The labelled points data are stored in `SSCT_data`. The function `to_spatial()` transform the `data.frame` into `sp` object.

```{r get points}
labelled_points <- SSCT_data %>% to_spatial() 
one_random_point <- labelled_points %>% sf::st_as_sf() %>% dplyr::sample_n(1)
one_random_point
```

# Loading `sen2r`

```{r libraries}
library(sen2r)
```

# Listing S2 products


```{r s2_list}
s2_products <- s2_list(
	spatial_extent = one_random_point,
	time_interval = c("2017-06-01", "2018-10-01"),
	time_period = "seasonal",
	level = "auto",
	max_cloud = 0
)
print(s2_products)
safe_getMetadata(s2_products, "sensing_datetime")	
```


# Products

```{r download, eval = TRUE}
# Set paths
out_dir  <- "/media/hguillon/hrvg/research/data/s2/sen2r_output/" # output folder
safe_dir <- "/media/hguillon/hrvg/research/data/s2/sen2r_safe/" # folder to store downloaded SAFE

paths <- sen2r(
  gui = FALSE,
  sel_sensor = c("s2a", "s2b"),
  timewindow = c(as.Date("2019-06-01"), as.Date("2020-10-01")),
  timeperiod = "seasonal",
  step_atmcorr = "l2a",
  max_cloud_safe = 20,
  list_prods = c("BOA","SCL"),
  list_rgb = c("RGB432B"),
  list_indices = c("NDVI"),
  extent = one_random_point,
  path_l1c = safe_dir,
  path_l2a = safe_dir,
  path_out = out_dir,
  order_lta = FALSE
)
```

# Appendix 

## Description of Sentinel-2 MSI products

> 0. Level-0 is compressed raw data. The Level-0 product contains all the information required to generate the Level-1 (and upper) product levels.
> 1. Level-1
> 	+ Level-1A is uncompressed raw data with spectral bands coarsely coregistered and ancillary data appended.
> 	+ Level-1B data is radiometrically corrected radiance data. The physical geometric model is refined using available ground control points and appended to the product, but not applied.
> 	+ Level-1C product provides orthorectified Top-Of-Atmosphere (TOA) reflectance, with sub-pixel multispectral registration. Cloud and land/water masks are included in the product.
> 2. Level-2A product provides orthorectified Bottom-Of-Atmosphere (BOA) reflectance, with sub-pixel multispectral registration. A Scene Classification map (cloud, cloud shadows, vegetation, soils/deserts, water, snow, etc.) is included in the product.

from [S2 MSI technical guide](https://dragon3.esa.int/web/sentinel/technical-guides/sentinel-2-msi/products-algorithms)

## SAFE format

> The SAFE format has been designed to act as a common format for archiving and conveying data within ESA Earth Observation archiving facilities. The SAFE format wraps a folder containing image data in a binary data format and product metadata in XML. This flexibility allows the format to be scalable enough to represent all levels of SENTINEL products.

> A SENTINEL-2 product refers to a directory folder that contains a collection of information (Figure 1). It includes:

> - a manifest.safe file which holds the general product information in XML
> - a preview image in JPEG2000 format
> - subfolders for measurement datasets including image data (granules/tiles) in GML-JPEG2000 format
> - subfolders for datastrip level information
> - a subfolder with auxiliary data (e.g. International Earth Rotation & Reference Systems (IERS) bulletin)
> - HTML previews

from [S2 MSI data formats](https://dragon3.esa.int/web/sentinel/user-guides/sentinel-2-msi/data-formats)