---
title: "Processing Sentinel 2 products"
author:
- name: HervÃ© Guillon
date: "`r format(Sys.time(), '%d %B %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Processing Sentinel 2 products}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  fig.width = 7, 
  fig.height = 7
)
```

# Loading libraries

```{r libraries}
library(AIgeomorphologist)
library(sen2r)
library(progress)
library(foreach)
library(doFuture)
```

# Parameters

We define here the parameters corresponding to the parameters used for retrieving and downloading the SAFE tiles in this [vignette](articles/retrieving_s2.html).

```{r download, eval = FALSE}
# Parameters
labelled_points <- SSCT_data %>% to_spatial() %>% sf::st_as_sf()
cloud_threshold <- 5.6
time_interval <- c(as.Date("2019-06-01"), as.Date("2020-10-01"))
time_period <- "full"
level <- "L2A"
availability <- "online"
.radius <- 1000 # m

# Set paths
safe_dir <- "G:/S2_data/SAFE/" # folder to store downloaded SAFE
out_dir  <- "G:/S2_data/sen2r_output/" # output folder

pb <- progress_bar$new(format = "[:bar] :current/:total - :percent in :elapsed/:eta \n", total = nrow(labelled_points), show_after = 0)
invisible(pb$tick(0))

for (n in seq(nrow(labelled_points))){
	current_point <- labelled_points[n, ]
	.out_dir <- file.path(out_dir, as.character(current_point$SiteID))
	if(!dir.exists(.out_dir)) dir.create(.out_dir)
	paths <- tryCatch(
		sen2r(
			gui = FALSE,
			timewindow = time_interval,
			timeperiod = time_period,
			online = (availability == "online"),
			step_atmcorr = tolower(level),
			max_cloud_safe = cloud_threshold,
			list_prods = c("BOA","SCL"),
			extent = current_point %>% point_to_geojson_polygon(radius = .radius),
			path_l1c = safe_dir,
			path_l2a = safe_dir,
			path_out = .out_dir,
			order_lta = FALSE,
			clip_on_extent = TRUE,
			processing_order = "mixed",
			thumbnails = FALSE,
			parallel = 4,
			preprocess = TRUE
		), 
		error = function(e) e)
	pb$tick()
	gc()
}
```

```{r}
dirs <- list.dirs(.out_dir, full.names = TRUE, recursive = FALSE)
d <- dirs[grepl("BOA", dirs)]
paths <- list.files(d, full.names = TRUE)
dop <- sapply(sapply(paths, basename), function(str) unlist(strsplit(str, "_"))[[2]]) %>% unname()
dop <- as.Date(dop, format = "%Y%m%d")
all_rasters <- stars::read_stars(paths, along = list(time = dop))
median_raster <- all_rasters %>% stars::st_apply(c("x", "y", "band"), median, na.rm = TRUE)
file_out <- file.path(.out_dir, paste0(paths %>% tail(1) %>% basename))
stars::write_stars(median_raster, file_out)
path2rgb <- s2_rgb(file_out, subdirs = FALSE, outdir = .out_dir, overwrite = TRUE)
read_stars(path2rgb) %>% st_rgb() %>% plot()
path2ndvi <- s2_calcindices(file_out, "NDVI", subdirs = FALSE, outdir = .out_dir, overwrite = TRUE)
read_stars(path2ndvi) %>% plot()

```

